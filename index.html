<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRK: Comparador de Tarifas 2.0 TD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        drk: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        'cta-red': {
                            500: '#CC0000',
                            600: '#A00000',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #interactive.viewport { position: relative; width: 100%; height: auto; overflow: hidden; border-radius: 1rem; }
        #interactive.viewport > video { width: 100%; height: 100%; object-fit: cover; }
        .loading-ring { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #0ea5e9; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body class="flex flex-col min-h-screen text-slate-800">

    <!-- Navbar -->
    <div class="w-full bg-drk-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-lg mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold tracking-tight">DRK <span class="text-drk-500">Energía</span></h1>
            <span class="text-xs bg-drk-800 px-2 py-1 rounded text-drk-100">Comparador Pro 2.0TD</span>
        </div>
    </div>

    <div id="app" class="w-full max-w-lg mx-auto p-4 md:p-6 flex-grow">
        
        <!-- Vista Inicial -->
        <div id="initial-view" class="fade-in">
            <div class="bg-white p-6 rounded-3xl shadow-xl text-center border-t-4 border-drk-500 relative">
                <div class="absolute top-4 right-4 bg-drk-500 px-2 py-1 rounded-full text-white text-xs font-bold shadow-md">
                    V - <span id="tariff-display-badge">0</span>
                </div>
                <div class="w-16 h-16 bg-drk-50 rounded-full flex items-center justify-center mx-auto mb-4 text-drk-600">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path></svg>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Analizar Factura</h2>
                <p class="text-slate-500 mb-6">Escanea el código QR de la factura.</p>
                <button id="start-scan-btn" class="w-full bg-gradient-to-r from-drk-600 to-drk-800 hover:from-drk-700 hover:to-drk-900 text-white font-bold py-4 px-6 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.125 3h3.75a2 2 0 011.664.89l.812 1.22a2 2 0 001.664.89H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span>ESCANEAR QR AHORA</span>
                </button>
                <input type="file" id="image-file-input" accept="image/*" class="hidden">
                <button id="upload-menu-btn" class="w-full bg-drk-50 hover:bg-drk-100 text-drk-800 font-bold py-3 px-6 rounded-xl shadow-sm transform transition active:scale-95 flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1m-4-5l-1-1m0 0l-1-1m0 0l-1-1M12 12v.01"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    <span>OPCIONES QR MANUAL</span>
                </button>
                <p id="loading-status" class="text-center text-sm text-slate-400 mt-4 hidden">Cargando tarifas...</p>
            </div>
        </div>

        <!-- Vista Escáner -->
        <div id="scanner-view" class="hidden flex-col h-full">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-slate-700">Escaneando...</h2>
                <button id="stop-scan-btn" class="text-red-500 font-bold text-sm bg-red-50 px-3 py-1 rounded-lg">Cancelar</button>
            </div>
            <div class="relative w-full aspect-[3/4] bg-black rounded-2xl overflow-hidden shadow-2xl mb-4">
                <div id="interactive" class="viewport w-full h-full"></div>
                <div class="absolute inset-0 border-2 border-drk-500 opacity-50 m-8 rounded-lg pointer-events-none"></div>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="w-64 h-1 bg-red-500 opacity-50"></div>
                </div>
            </div>
            <p id="scan-message" class="text-center text-sm text-slate-500 mb-4">Enfoca el código QR de la CNMC.</p>
            <button id="capture-photo-btn" class="w-full bg-white border-2 border-drk-500 text-drk-800 font-bold py-3 rounded-xl shadow-sm flex items-center justify-center gap-2">Capturar Foto Manualmente</button>
        </div>

        <!-- Vista Resultados -->
        <div id="results-view" class="hidden animate-fade-in-up">
            <div class="text-center mb-6">
                <div class="inline-flex items-center gap-2 bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold mb-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Análisis Completado
                </div>
                <h2 class="text-2xl font-black text-slate-800">Resultado del Estudio</h2>
                <p class="text-sm text-slate-500">CUPS: <span id="cups-value" class="font-mono text-slate-700"></span></p>
            </div>

            <!-- Tarjeta Resultado en Pantalla -->
            <div class="bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-100 mb-8 relative">
                <div class="bg-gradient-to-r from-drk-800 to-drk-600 p-6 text-white text-center relative overflow-hidden">
                    <p class="uppercase tracking-widest text-xs font-semibold text-drk-100 mb-1">LA MEJOR OPCIÓN PARA TI ES</p>
                    <h2 id="best-offer-name" class="text-2xl md:text-3xl font-extrabold leading-tight mb-2">Nombre Tarifa</h2>
                    <p id="best-offer-desc" class="text-drk-100 text-sm opacity-90">Descripción</p>
                </div>
                <div class="p-6">
                    <div class="flex flex-col gap-6">
                        <div class="text-center">
                            <p class="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">Tu Ahorro Anual Estimado</p>
                            <p id="savings-estimate" class="text-5xl font-black text-green-500 tracking-tight">- €</p>
                        </div>
                        <div class="w-full grid grid-cols-2 text-center text-sm border-b pb-4 border-slate-100">
                            <div class="border-r border-slate-200 pr-2">
                                <p class="text-slate-400 text-xs font-semibold mb-2 uppercase">TU FACTURA ACTUAL</p>
                                <div class="mb-3">
                                    <p class="text-xl font-bold text-red-400 line-through decoration-red-400/50 decoration-2" id="old-period-cost-display">0,00 €</p>
                                    <p class="text-xs text-slate-500 font-medium" id="old-period-days-label">Total Periodo</p> 
                                </div>
                                <div>
                                    <p class="text-lg font-bold text-red-500 line-through decoration-red-500/50 decoration-2" id="old-annual-cost-display">0,00 €/año</p>
                                </div>
                            </div>
                            <div class="pl-2">
                                <p class="text-drk-800 text-xs font-semibold mb-2 uppercase">TU NUEVO COSTE DRK</p>
                                <div class="mb-3">
                                    <p class="text-2xl font-black text-drk-900" id="new-monthly-cost-display">0,00 €/mes</p>
                                    <p class="text-xs text-drk-800 font-medium">Estimado Mensual</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-black text-drk-900" id="new-annual-cost-display">0,00 €/año</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones -->
            <div class="grid grid-cols-1 gap-3 mb-8">
                 <button id="send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3 mb-3">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-4-4l-4 4m0 0l-4-4m4 4V5"></path></svg>
                    <span>COPIAR COMPARATIVO</span>
                </button>
                 <button onclick="document.getElementById('details-container').classList.toggle('hidden')" class="text-center text-drk-800 font-bold text-sm hover:underline flex items-center justify-center gap-1">
                    Ver desglose detallado del cálculo
                </button>
            </div>

            <div id="details-container" class="hidden space-y-6">
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-drk-500 pl-3">Datos Extraídos</h3>
                <div id="user-consumption-details" class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm text-sm"></div>
                <h3 class="text-lg font-bold text-slate-800 border-l-4 border-green-500 pl-3">Cálculo Oficial</h3>
                <div id="cost-breakdown" class="bg-white p-0 rounded-xl border border-slate-200 shadow-sm overflow-hidden text-sm"></div>
                <!-- Debug invisible -->
                <div id="comparison-details" class="hidden"></div> 
            </div>

            <div class="mt-8">
                <button onclick="resetApp()" class="w-full bg-white border-2 border-slate-200 hover:border-drk-500 text-slate-600 hover:text-drk-800 font-bold py-4 rounded-xl transition flex items-center justify-center gap-2">
                    Realizar Nueva Comparación
                </button>
            </div>
        </div>
        
        <!-- Modales -->
        <div id="qr-options-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4">Seleccione Opción</h3>
                <button id="modal-upload-file-btn" class="w-full bg-drk-800 hover:bg-drk-900 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-3">Subir Imagen</button>
                <button id="modal-paste-image-btn" class="w-full bg-drk-600 hover:bg-drk-800 text-white font-bold py-3 px-6 rounded-xl shadow-md mb-4">Pegar Imagen (CTRL+V)</button>
                <button onclick="document.getElementById('qr-options-modal').classList.add('hidden');" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 rounded-xl">Cancelar</button>
                <textarea id="paste-catcher" class="opacity-0 w-0 h-0 absolute -z-10" aria-hidden="true"></textarea>
            </div>
        </div>

        <div id="send-offer-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full">
                <h3 class="text-xl font-bold text-drk-800 mb-4">Datos del Comercial y Cliente</h3>
                <input type="text" id="comercial-code-input" placeholder="CÓDIGO COMERCIAL (Obligatorio)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-drk-500 outline-none text-sm">
                <input type="text" id="client-name-input" placeholder="Nombre Cliente (Opcional)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-drk-500 outline-none text-sm">
                <input type="tel" id="client-phone-input" placeholder="Teléfono Cliente (Opcional)" class="w-full mb-3 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-drk-500 outline-none text-sm">
                <input type="email" id="client-email-input" placeholder="Email Cliente (Opcional)" class="w-full mb-4 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-drk-500 outline-none text-sm">
                <button id="execute-send-offer-btn" class="w-full bg-cta-red-500 hover:bg-cta-red-600 text-white font-bold py-3 rounded-xl shadow-md mb-3">COPIAR AL PORTAPAPELES</button>
                <button onclick="document.getElementById('send-offer-modal').classList.add('hidden');" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-600 font-bold py-3 rounded-xl text-sm">Cancelar</button>
            </div>
        </div>

        <div id="error-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full text-center">
                <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4" id="error-icon"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                <h3 class="text-lg font-bold text-slate-800 mb-2" id="error-title">¡Ups! Algo salió mal</h3>
                <p id="error-message" class="text-slate-600 text-sm mb-6"></p>
                <button onclick="hideErrorModal()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl">Entendido</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        const SHEET_ID = '13JrbK1T4x5W-2U7KPFprCXMl-FxizxofPA5w8MINyak';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=0`;
        const ANNUAL_DAYS = 365;
        const LOCAL_STORAGE_KEY = 'drk_loaded_tariffs';

        let currentTariffs = [];
        let lastComparisonResult = null;
        let scannerRunning = false;
        let stream = null, video = null, canvas = null, canvasCtx = null, animationFrameId = null;

        const els = {
            initialView: document.getElementById('initial-view'),
            resultsView: document.getElementById('results-view'),
            scannerView: document.getElementById('scanner-view'),
            interactiveViewport: document.getElementById('interactive'),
            startScanBtn: document.getElementById('start-scan-btn'),
            stopScanBtn: document.getElementById('stop-scan-btn'),
            capturePhotoBtn: document.getElementById('capture-photo-btn'),
            loadingStatus: document.getElementById('loading-status'),
            sendOfferBtn: document.getElementById('send-offer-btn'),
            sendOfferModal: document.getElementById('send-offer-modal'),
            comercialCodeInput: document.getElementById('comercial-code-input'),
            clientNameInput: document.getElementById('client-name-input'),
            clientPhoneInput: document.getElementById('client-phone-input'),
            clientEmailInput: document.getElementById('client-email-input'),
            executeSendOfferBtn: document.getElementById('execute-send-offer-btn'),
            tariffDisplayBadge: document.getElementById('tariff-display-badge'),
            uploadMenuBtn: document.getElementById('upload-menu-btn'),
            imageFileInput: document.getElementById('image-file-input'),
            qrOptionsModal: document.getElementById('qr-options-modal'),
            modalPasteImageBtn: document.getElementById('modal-paste-image-btn'), 
            pasteCatcher: document.getElementById('paste-catcher'), 
            bestOfferName: document.getElementById('best-offer-name'),
            bestOfferDesc: document.getElementById('best-offer-desc'),
            savingsEstimate: document.getElementById('savings-estimate'),
            oldAnnualCostDisplay: document.getElementById('old-annual-cost-display'),
            newAnnualCostDisplay: document.getElementById('new-annual-cost-display'),
            oldPeriodCostDisplay: document.getElementById('old-period-cost-display'), 
            oldPeriodDaysLabel: document.getElementById('old-period-days-label'), 
            newMonthlyCostDisplay: document.getElementById('new-monthly-cost-display'), 
            cupsValue: document.getElementById('cups-value'),
            userConsumptionDetails: document.getElementById('user-consumption-details'),
            costBreakdown: document.getElementById('cost-breakdown')
        };

        function updateTariffCount() {
            els.tariffDisplayBadge.textContent = currentTariffs.length;
            if (currentTariffs.length > 0) {
                els.loadingStatus.classList.add('hidden');
                els.startScanBtn.disabled = false;
                els.uploadMenuBtn.disabled = false;
            } else {
                els.loadingStatus.textContent = "Error: No hay tarifas disponibles. Recargando...";
                els.loadingStatus.classList.remove('hidden');
                els.startScanBtn.disabled = true;
                els.uploadMenuBtn.disabled = true;
            }
        }
        function loadTariffsFromStorage() { try { const stored = localStorage.getItem(LOCAL_STORAGE_KEY); if (stored) return JSON.parse(stored); } catch (e) { console.error("Storage Error", e); } return []; }
        function saveTariffsToStorage(tariffs) { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tariffs)); }
        
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 2) throw new Error("Archivo CSV vacío.");
            if (lines[0].toLowerCase().includes('<html')) throw new Error("Error de acceso (HTML devuelto).");
            
            let rawHeaders = lines[0].trim();
            const delimiter = ','; 
            const headers = rawHeaders.split(delimiter).map(h => h.trim().toLowerCase().replace(/"/g, ''));
            const requiredHeaders = ['name', 'description', 'p1_price', 'p2_price', 'p3_price', 'p_potencia_1', 'p_potencia_2'];
            if (!requiredHeaders.every(h => headers.includes(h))) throw new Error(`Faltan cabeceras. Detectadas: ${headers.join(', ')}`);

            const newTariffs = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const values = [];
                let current = '';
                let inQuotes = false;
                for (let k = 0; k < line.length; k++) {
                    const char = line[k];
                    if (char === '"' && line[k+1] !== '"') { inQuotes = !inQuotes; }
                    else if (char === delimiter && !inQuotes) { values.push(current); current = ''; }
                    else { current += char; }
                }
                values.push(current); 
                if (values.length !== headers.length) continue;
                
                const tariff = { cups_match: ["2.0TD"] };
                let isValidTariff = true;
                for (let j = 0; j < headers.length; j++) {
                    const header = headers[j];
                    const value = values[j].trim().replace(/^"|"$/g, '').replace(/""/g, '"'); 
                    if (header.includes('price') || header.includes('potencia')) {
                        const numValue = parseFloat(value.replace(',', '.')); 
                        if (!isNaN(numValue)) { tariff[header] = numValue; } 
                        else { isValidTariff = false; break; }
                    } else { tariff[header] = value; }
                }
                if (isValidTariff && tariff.p1_price !== undefined) newTariffs.push(tariff);
            }
            return newTariffs;
        }

        async function fetchTariffsFromSheet() {
            els.loadingStatus.textContent = "Cargando tarifas...";
            els.loadingStatus.classList.remove('hidden');
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const csvText = await response.text();
                const loaded = parseCSV(csvText);
                if (loaded.length === 0) throw new Error("No se encontraron tarifas.");
                currentTariffs = loaded;
                saveTariffsToStorage(currentTariffs);
            } catch (err) {
                console.error("Error fetching:", err);
                currentTariffs = loadTariffsFromStorage();
                if (currentTariffs.length === 0) window.showErrorModal("Error crítico: No se pudieron cargar tarifas ni hay caché.");
            } finally {
                updateTariffCount();
            }
        }

        function dateDiffInDays(d1, d2) {
            const parse = (str) => {
                if (!str || str.length !== 10) return null;
                if (str.includes('/')) { const p = str.split('/'); return new Date(p[2], p[1]-1, p[0]); }
                if (str.includes('-')) { const p = str.split('-'); return new Date(p[0], p[1]-1, p[2]); }
                if (str.length === 8) { const y = str.substring(0,4), m = str.substring(4,6), d = str.substring(6,8); return new Date(y, m-1, d); }
                return null;
            }
            const dt1 = parse(d1), dt2 = parse(d2);
            if(!dt1 || !dt2) return 0;
            return Math.ceil(Math.abs(dt2 - dt1) / (1000 * 60 * 60 * 24)) + 1;
        }

        function handleQRRead(raw) {
            if (raw.includes('?')) raw = raw.split('?')[1] || raw;
            const p = {};
            raw.split('&').forEach(part => { const [k, v] = part.split('='); if(k) p[k] = decodeURIComponent(v||'').replace(',', '.'); });
            
            const data = {
                cups: p.cups || 'No detectado',
                dias_facturados: dateDiffInDays(p.iniF, p.finF),
                consumo_punta: parseFloat(p.cfP1||0),
                consumo_llano: parseFloat(p.cfP2||0),
                consumo_valle: parseFloat(p.cfP3||0),
                consumo_total: parseFloat(p.cfP1||0)+parseFloat(p.cfP2||0)+parseFloat(p.cfP3||0),
                potencia_p1_kw: parseFloat(p.pP1||0),
                potencia_p2_kw: parseFloat(p.pP2||0),
                importe_total: parseFloat(p.imp||0), 
                fechas: `${p.iniF || '?'} - ${p.finF || '?'}`
            };

            if (data.dias_facturados === 0 || data.importe_total === 0) {
                window.showErrorModal("QR incompleto o inválido.");
                window.resetApp();
                return;
            }
            compareOffers(data);
        }

        function compareOffers(data) {
            const IVA_RATE = 0.21;
            const IE_RATE = 0.05113; 
            const factorAnual = ANNUAL_DAYS / data.dias_facturados;
            const originalBillAnnual = data.importe_total * factorAnual; 

            let bestOffer = null;
            let minAnnualCost = Infinity;
            let bestBreakdown = null;

            currentTariffs.forEach(t => {
                const priceP1Day = t.p_potencia_1 / ANNUAL_DAYS;
                const priceP2Day = t.p_potencia_2 / ANNUAL_DAYS;
                
                const costP1 = data.potencia_p1_kw * data.dias_facturados * priceP1Day;
                const costP2 = data.potencia_p2_kw * data.dias_facturados * priceP2Day;
                const subPower = costP1 + costP2;

                const costE1 = data.consumo_punta * t.p1_price;
                const costE2 = data.consumo_llano * t.p2_price;
                const costE3 = data.consumo_valle * t.p3_price;
                const subEnergy = costE1 + costE2 + costE3;

                const subBase = subPower + subEnergy;
                const costIE = subBase * IE_RATE;
                const baseImp = subBase + costIE;
                const costIVA = baseImp * IVA_RATE;
                
                const totalPeriod = baseImp + costIVA; 
                const totalAnnual = totalPeriod * factorAnual; 

                if (totalAnnual < minAnnualCost) {
                    minAnnualCost = totalAnnual;
                    bestOffer = t;
                    bestBreakdown = {
                        ...data, costP1, costP2, subPower, costE1, costE2, costE3, subEnergy,
                        subBase, costIE, baseImp, costIVA, totalPeriod, totalAnnual,
                        priceP1Day, priceP2Day, IE_RATE,
                        originalBillAnnual, savings: originalBillAnnual - totalAnnual,
                        offer: t
                    };
                }
            });

            if (!bestOffer) return window.showErrorModal("No se encontraron tarifas compatibles.");
            lastComparisonResult = bestBreakdown;
            renderResultsUI(bestOffer, bestBreakdown);
            showView('results-view');
        }

        function renderResultsUI(offer, bd) {
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n);
            const numPrice = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 8, maximumFractionDigits: 8 }).format(n);

            els.cupsValue.textContent = bd.cups;
            els.bestOfferName.textContent = offer.name;
            els.bestOfferDesc.textContent = offer.description;
            // Usamos el color corporativo para el ahorro en pantalla
            const savingsColor = bd.savings >= 0 ? "text-drk-800" : "text-red-500"; 
            els.savingsEstimate.textContent = eur(bd.savings);
            els.savingsEstimate.className = `text-5xl font-black ${savingsColor} tracking-tight`;
            
            els.oldPeriodCostDisplay.textContent = eur(bd.importe_total);
            els.oldPeriodDaysLabel.textContent = `Total Periodo (${bd.dias_facturados} días)`;
            els.oldAnnualCostDisplay.textContent = eur(bd.originalBillAnnual) + "/año";
            
            els.newMonthlyCostDisplay.textContent = eur(bd.totalAnnual / 12) + "/mes";
            els.newAnnualCostDisplay.textContent = eur(bd.totalAnnual) + "/año";

            els.userConsumptionDetails.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div><p class="text-xs text-slate-500">Periodo</p><p class="font-bold text-slate-700">${bd.dias_facturados} días</p></div>
                    <div><p class="text-xs text-slate-500">Fechas</p><p class="font-bold text-slate-700">${bd.fechas}</p></div>
                    <div class="col-span-2 border-t pt-2 mt-2">
                        <div class="flex justify-between text-xs mb-1"><span>E1</span><span class="font-mono">${num(bd.consumo_punta,0)} kWh</span></div>
                        <div class="flex justify-between text-xs mb-1"><span>E2</span><span class="font-mono">${num(bd.consumo_llano,0)} kWh</span></div>
                        <div class="flex justify-between text-xs mb-1"><span>E3</span><span class="font-mono">${num(bd.consumo_valle,0)} kWh</span></div>
                        <div class="flex justify-between font-bold text-drk-800 mt-1"><span>Total</span><span>${num(bd.consumo_total,0)} kWh</span></div>
                    </div>
                </div>
            `;

            els.costBreakdown.innerHTML = `
                <div class="bg-white p-6 font-mono text-xs md:text-sm text-slate-600 leading-relaxed">
                    <div class="text-center border-b-2 border-dashed border-slate-300 pb-4 mb-4">
                        <h4 class="font-bold text-lg text-slate-800 uppercase">${offer.name}</h4>
                        <p>Simulación ${bd.dias_facturados} días</p>
                    </div>
                    <div class="mb-4">
                        <p class="font-bold text-slate-800 mb-1">POTENCIA (€/kW Año)</p>
                        <div class="flex justify-between"><span>P1 (${num(bd.potencia_p1_kw,2)} kW x ${numPrice(bd.priceP1Day)})</span><span>${num(bd.costP1,2)} €</span></div>
                        <div class="flex justify-between"><span>P2 (${num(bd.potencia_p2_kw,2)} kW x ${numPrice(bd.priceP2Day)})</span><span>${num(bd.costP2,2)} €</span></div>
                    </div>
                    <div class="mb-4">
                        <p class="font-bold text-slate-800 mb-1">ENERGÍA (€/kWh)</p>
                        <div class="flex justify-between"><span>E1 (${num(bd.consumo_punta,0)} kWh x ${numPrice(offer.p1_price)})</span><span>${num(bd.costE1,2)} €</span></div>
                        <div class="flex justify-between"><span>E2 (${num(bd.consumo_llano,0)} kWh x ${numPrice(offer.p2_price)})</span><span>${num(bd.costE2,2)} €</span></div>
                        <div class="flex justify-between"><span>E3 (${num(bd.consumo_valle,0)} kWh x ${numPrice(offer.p3_price)})</span><span>${num(bd.costE3,2)} €</span></div>
                    </div>
                    <div class="border-t border-slate-200 pt-2 mb-2">
                        <div class="flex justify-between font-bold text-slate-800"><span>SUBTOTAL</span><span>${num(bd.subBase,2)} €</span></div>
                        <div class="flex justify-between"><span>Imp. Eléc.</span><span>${num(bd.costIE,2)} €</span></div>
                        <div class="flex justify-between font-bold"><span>BASE</span><span>${num(bd.baseImp,2)} €</span></div>
                        <div class="flex justify-between"><span>IVA</span><span>${num(bd.costIVA,2)} €</span></div>
                    </div>
                    <div class="bg-drk-900 text-white p-3 rounded-lg flex justify-between items-center text-md font-bold mb-1"><span>TOTAL MES</span><span>${eur(bd.totalAnnual / 12)}</span></div>
                </div>
            `;
        }

        // GENERADOR DE HTML PARA COPIAR (Diseño PDF DETALLADO)
        function generateStyledHtmlOffer(commercialCode) {
            const bd = lastComparisonResult;
            const offer = bd.offer;
            const eur = (n) => new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(n);
            const num = (n, d=2) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n);
            // Usamos 8 decimales para los precios en el desglose
            const numPrice = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 8, maximumFractionDigits: 8 }).format(n);
            const numPriceFormula = (n) => new Intl.NumberFormat('es-ES', { minimumFractionDigits: 6, maximumFractionDigits: 6 }).format(n);
            
            // Colores DRK
            const BLUE_DARK = '#0c4a6e'; 
            const BLUE_MED = '#075985';
            const BLUE_CTA = '#0284c7'; // Usaremos el Azul CTA/600 para el ahorro
            const RED_CTA = '#CC0000';
            const BG_LIGHT = '#f0f9ff';

            const clientName = els.clientNameInput.value.trim() || '__________';
            const formalizationLink = `mailto:f.araujo@drk.es,r.guerra@drk.es,s.caballero@drk.es?subject=${encodeURIComponent(`ACEPTACIÓN OFERTA ${bd.cups}`)}&body=${encodeURIComponent(`Hola, acepto la oferta para el CUPS ${bd.cups}. Nombre: ${clientName}`)}`;

            // Estilos CSS Inline para máxima compatibilidad
            const tableMain = `width: 600px; max-width: 100%; border-collapse: collapse; font-family: Arial, sans-serif; border: 1px solid #ddd; margin: 0 auto; background: white;`;
            const headerCell = `background-color: ${BLUE_DARK}; color: white; padding: 15px; text-align: center;`;
            const sectionTitle = `background-color: ${BLUE_MED}; color: white; font-weight: bold; padding: 8px; font-size: 14px; margin-top: 10px;`;
            const rowLabel = `padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; color: #555;`;
            const rowValue = `padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; font-weight: bold; color: #333; text-align: right;`;
            // CAJA DE AHORRO CON COLOR AZUL CORPORATIVO (BLUE_CTA)
            const savingsBox = `background-color: ${BLUE_CTA}; color: white; font-size: 20px; font-weight: bold; padding: 15px; text-align: center; border-radius: 8px; margin: 15px 0;`;
            const btnStyle = `display: inline-block; background-color: ${RED_CTA}; color: white; padding: 12px 24px; text-decoration: none; font-weight: bold; border-radius: 6px; margin: 20px 0; font-size: 16px;`;
            const footerStyle = `background-color: ${BLUE_MED}; height: 5px; margin-top: 10px; border-radius: 0 0 8px 8px;`;

            // DETALLE DE LA FÓRMULA DEL DESGLOSE
            const desgloseRows = `
                <!-- TÉRMINO POTENCIA -->
                <tr><td colspan="2"><div style="font-weight: bold; color: ${BLUE_MED}; padding: 5px 0 2px 0;">TÉRMINO POTENCIA (Precio en €/kW Día)</div></td></tr>
                <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">P1 (${num(bd.potencia_p1_kw,2)} kW x ${bd.dias_facturados}d x ${numPriceFormula(bd.priceP1Day)})</td><td style="${rowValue} font-family: monospace; font-size: 12px;">${num(bd.costP1, 2)} €</td></tr>
                <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">P2 (${num(bd.potencia_p2_kw,2)} kW x ${bd.dias_facturados}d x ${numPriceFormula(bd.priceP2Day)})</td><td style="${rowValue} font-family: monospace; font-size: 12px;">${num(bd.costP2, 2)} €</td></tr>
                
                <!-- TÉRMINO ENERGÍA -->
                <tr><td colspan="2"><div style="font-weight: bold; color: ${BLUE_MED}; padding: 5px 0 2px 0;">TÉRMINO ENERGÍA (Precios en €/kWh)</div></td></tr>
                <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">E1 (${num(bd.consumo_punta,0)} kWh x ${numPriceFormula(offer.p1_price)})</td><td style="${rowValue} font-family: monospace; font-size: 12px;">${num(bd.costE1, 2)} €</td></tr>
                <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">E2 (${num(bd.consumo_llano,0)} kWh x ${numPriceFormula(offer.p2_price)})</td><td style="${rowValue} font-family: monospace; font-size: 12px;">${num(bd.costE2, 2)} €</td></tr>
                <tr><td style="${rowLabel} font-family: monospace; font-size: 12px;">E3 (${num(bd.consumo_valle,0)} kWh x ${numPriceFormula(offer.p3_price)})</td><td style="${rowValue} font-family: monospace; font-size: 12px;">${num(bd.costE3, 2)} €</td></tr>
                
                <!-- SUBTOTALES E IMPUESTOS -->
                <tr><td style="${rowLabel} border-top: 2px solid #333; font-weight: bold; color: ${BLUE_DARK};">SUBTOTAL (P+E)</td><td style="${rowValue} border-top: 2px solid #333; font-weight: bold; color: ${BLUE_DARK};">${num(bd.subBase, 2)} €</td></tr>
                <tr><td style="${rowLabel}">Impuesto Eléc. (${num(bd.IE_RATE * 100, 3)}%)</td><td style="${rowValue}">${num(bd.costIE, 2)} €</td></tr>
                <tr><td style="${rowLabel} font-weight: bold;">BASE IMPONIBLE</td><td style="${rowValue} font-weight: bold;">${num(bd.baseImp, 2)} €</td></tr>
                <tr><td style="${rowLabel}">IVA (21%)</td><td style="${rowValue}">${num(bd.costIVA, 2)} €</td></tr>
                
                <!-- TOTALES FINALES (TOTAL MES Y TOTAL AÑO) -->
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold;">TOTAL MES (PERIODO FACTURADO - ${bd.dias_facturados} DÍAS)</td><td style="${rowValue} background-color: #eee; font-size: 16px;">${eur(bd.totalPeriod)}</td></tr>
                 <!-- LÍNEA DE TOTAL AÑO -->
                <tr><td style="${rowLabel} background-color: #eee; font-weight: bold;">TOTAL AÑO (PROYECTADO)</td><td style="${rowValue} background-color: #eee; font-size: 16px;">${eur(bd.totalAnnual)}</td></tr>
            `;
            
            // TABLA DE RESUMEN DE PRECIOS UNITARIOS
            const preciosResumenTable = `
                <tr><td colspan="2"><div style="${sectionTitle}">RESUMEN DE PRECIOS DE LA OFERTA ÚNICA</div></td></tr>
                <tr><td colspan="2" style="padding: 0;">
                    <table width="100%" cellpadding="0" cellspacing="0" style="font-family: Arial, sans-serif; font-size: 12px;">
                        <tr style="background-color: #f5f5f5;">
                            <th style="padding: 5px 8px; text-align: left; color: ${BLUE_DARK};">CONCEPTO</th>
                            <th style="padding: 5px 8px; text-align: right; color: ${BLUE_DARK};">DRK ENERGÍA</th>
                        </tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P1 (€/kW/día)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">${numPriceFormula(bd.priceP1Day)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Potencia P2 (€/kW/día)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">${numPriceFormula(bd.priceP2Day)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energía E1 (€/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">${numPriceFormula(offer.p1_price)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energía E2 (€/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">${numPriceFormula(offer.p2_price)}</td></tr>
                        <tr><td style="padding: 5px 8px; border-bottom: 1px solid #eee;">Energía E3 (€/kWh)</td><td style="padding: 5px 8px; border-bottom: 1px solid #eee; text-align: right; font-weight: bold;">${numPriceFormula(offer.p3_price)}</td></tr>
                        <tr style="background-color: ${BG_LIGHT}; font-weight: bold;"><td style="padding: 8px; color: ${BLUE_DARK};">AHORRO ANUAL</td><td style="padding: 8px; text-align: right; font-size: 14px; color: ${BLUE_CTA};">${eur(bd.savings)}</td></tr>
                        <!-- ESPACIO SOLICITADO -->
                        <tr style="background-color: white; height: 10px;"><td colspan="2"></td></tr>
                    </table>
                </td></tr>
            `;
            
            // NUEVO RESUMEN DE AHORRO AL FINAL
            const finalSavingsSummary = `
                <tr><td colspan="2" style="padding: 0 20px 0 20px; text-align: center;">
                    <div style="text-align: center; margin: 15px 0 5px 0;">
                        <p style="margin: 0; font-size: 16px; color: ${BLUE_DARK}; font-weight: bold;">RESUMEN DE AHORRO FINAL</p>
                    </div>
                    <div style="background-color: ${BG_LIGHT}; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                        <p style="margin: 0; font-size: 14px; color: #555;">TU AHORRO ANUAL ESTIMADO ES:</p>
                        <span style="font-size: 32px; font-weight: bold; color: ${BLUE_CTA}; display: block; margin-top: 5px;">${eur(bd.savings)}</span>
                    </div>
                </td></tr>
            `;


            return `
                <table cellpadding="0" cellspacing="0" style="${tableMain}">
                    <!-- HEADER -->
                    <tr><td colspan="2" style="${headerCell}">
                        <h1 style="margin:0; font-size: 24px;">ESTUDIO DE AHORRO</h1>
                        <p style="margin:5px 0 0 0; font-size: 14px; opacity: 0.9;">COMPARATIVA PROFESIONAL - DRK ENERGÍA</p>
                    </td></tr>
                    
                    <!-- DATOS CLIENTE -->
                    <tr><td colspan="2" style="padding: 15px;">
                        <p style="margin: 0; font-size: 13px;"><strong>CLIENTE:</strong> ${clientName}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>CUPS:</strong> ${bd.cups}</p>
                        <p style="margin: 5px 0 0 0; font-size: 13px;"><strong>COMERCIAL:</strong> ${els.comercialCodeInput.value || 'N/A'}</p>
                    </td></tr>

                    <!-- TARIFA GANADORA -->
                    <tr><td colspan="2" style="background-color: ${BG_LIGHT}; padding: 15px; text-align: center; border-top: 2px solid ${BLUE_MED}; border-bottom: 2px solid ${BLUE_MED};">
                        <p style="margin: 0; color: ${BLUE_MED}; font-size: 12px; font-weight: bold; letter-spacing: 1px;">LA MEJOR OPCIÓN PARA TI ES</p>
                        <h2 style="margin: 5px 0 0 0; color: ${BLUE_DARK}; font-size: 22px;">${offer.name}</h2>
                    </td></tr>

                    <!-- AHORRO (RESUMEN POTENTE INICIAL) -->
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <div style="text-align: center; margin: 25px 0 10px 0;">
                            <p style="margin: 0; font-size: 16px; color: #555; font-weight: bold;">TU AHORRO ANUAL ESTIMADO ES:</p>
                        </div>
                        <div style="${savingsBox}">
                            <span style="font-size: 38px;">${eur(bd.savings)}</span>
                            <p style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold;">¡CONSIGUE TU AHORRO ANUAL!</p>
                        </div>
                    </td></tr>

                    <!-- TABLA DE RESUMEN DE PRECIOS -->
                    ${preciosResumenTable}

                    <!-- COMPARATIVA (Se mantiene el formato lado a lado, pero se añade Total Anual) -->
                    <tr><td colspan="2" style="padding: 0 20px;">
                        <table width="100%" cellpadding="0" cellspacing="0" style="margin-bottom: 20px;">
                            <tr>
                                <td style="width: 50%; padding: 15px; background-color: #f9fafb; border: 1px solid #ddd; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase;">TU FACTURA ACTUAL</div>
                                    <div style="font-size: 20px; font-weight: bold; color: #ef4444; margin: 5px 0; text-decoration: line-through;">${eur(bd.originalBillAnnual)}</div>
                                    <div style="font-size: 11px; color: #666;">/ AÑO</div>
                                </td>
                                <td style="width: 50%; padding: 15px; background-color: ${BG_LIGHT}; border: 1px solid ${BLUE_MED}; text-align: center; vertical-align: top;">
                                    <div style="font-size: 11px; font-weight: bold; color: ${BLUE_MED}; text-transform: uppercase;">TU NUEVO COSTE DRK</div>
                                    <div style="font-size: 24px; font-weight: bold; color: ${BLUE_DARK}; margin: 5px 0;">${eur(bd.totalAnnual)}</div>
                                    <div style="font-size: 11px; color: ${BLUE_MED};">/ AÑO</div>
                                    <div style="font-size: 13px; font-weight: bold; color: ${BLUE_DARK}; margin-top: 5px;">${eur(bd.totalAnnual/12)} / MES</div>
                                </td>
                            </tr>
                        </table>
                    </td></tr>

                    <!-- DESGLOSE DETALLADO -->
                    <tr><td colspan="2"><div style="${sectionTitle}">DESGLOSE DETALLADO DE LA SIMULACIÓN (${offer.name})</div></td></tr>
                    ${desgloseRows}
                    
                    <!-- NUEVO RESUMEN DE AHORRO AL FINAL (Solicitado) -->
                    ${finalSavingsSummary}

                    <!-- CTA -->
                    <tr><td colspan="2" style="text-align: center; padding: 0 20px 20px 20px;">
                        <a href="${formalizationLink}" style="${btnStyle}">QUIERO LA OFERTA</a>
                        <p style="font-size: 10px; color: #999; margin-top: 10px;">[Colaborador: ${commercialCode}] | Este resumen es una simulación basada en su última factura.</p>
                    </td></tr>

                    <!-- PIE DE PÁGINA BONITO -->
                    <tr><td colspan="2" style="padding: 0; height: 10px;"><div style="${footerStyle}"></div></td></tr>
                </table>
            `;
        }

        async function handleCopyOffer() {
            if (!lastComparisonResult) return window.showErrorModal("Primero realice una comparación.");
            
            const commercialCode = els.comercialCodeInput.value.trim();
            if (!commercialCode) return window.showErrorModal("Indique el Código Comercial.");

            try {
                const htmlContent = generateStyledHtmlOffer(commercialCode);
                
                // Intento de copia HTML enriquecido
                const tempElement = document.createElement('div');
                tempElement.contentEditable = true;
                tempElement.innerHTML = htmlContent;
                tempElement.style.position = 'fixed';
                tempElement.style.left = '-9999px';
                document.body.appendChild(tempElement);
                
                const range = document.createRange();
                range.selectNodeContents(tempElement);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                
                let success = document.execCommand('copy');
                document.body.removeChild(tempElement);

                if (success) {
                    window.showMessageModal("✅ ¡Oferta copiada con éxito! Pegue en su email (Ctrl+V o Cmd+V).");
                    els.sendOfferModal.classList.add('hidden');
                } else {
                    // Si falla (móviles/iOS), notificamos el fallo de la copia enriquecida.
                    window.showErrorModal("No se pudo copiar el diseño visual (limitación del dispositivo). Intente desde un PC.");
                }
            } catch (e) {
                console.error("Error al copiar al portapapeles:", e);
                window.showErrorModal(`Error de Portapapeles: ${e.message}`);
            }
        }

        function showView(viewId) {
            document.getElementById('initial-view').classList.add('hidden');
            document.getElementById('results-view').classList.add('hidden');
            document.getElementById('scanner-view').classList.add('hidden');
            document.getElementById('results-view').classList.remove('animate-fade-in-up'); 
            const target = document.getElementById(viewId);
            target.classList.remove('hidden');
            if(viewId === 'results-view') target.classList.add('animate-fade-in-up');
        }
        window.showErrorModal = (msg) => {
            document.getElementById('error-title').textContent = "¡Atención!";
            document.getElementById('error-message').textContent = msg;
            document.getElementById('error-modal').classList.remove('hidden');
            document.getElementById('error-modal').classList.add('flex');
        }
        window.showMessageModal = (msg) => {
             document.getElementById('error-title').textContent = "Éxito";
             document.getElementById('error-icon').className = "w-12 h-12 bg-drk-100 text-drk-500 rounded-full flex items-center justify-center mx-auto mb-4";
             document.getElementById('error-icon').innerHTML = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
             document.getElementById('error-message').textContent = msg;
             document.getElementById('error-modal').classList.remove('hidden');
             document.getElementById('error-modal').classList.add('flex');
        }
        window.hideErrorModal = () => {
            document.getElementById('error-modal').classList.add('hidden');
            document.getElementById('error-modal').classList.remove('flex');
        }
        window.resetApp = () => {
            stopScanner();
            lastComparisonResult = null;
            showView('initial-view');
            els.loadingStatus.classList.add('hidden');
            els.startScanBtn.disabled = false;
            els.uploadMenuBtn.disabled = false; 
        };
        function startScanner() {
            if (currentTariffs.length === 0) return window.showErrorModal("Cargando tarifas, espere...");
            if (scannerRunning) return;
            showView('scanner-view');
            scannerRunning = true;
            video = document.createElement('video');
            video.autoplay = true;
            video.playsInline = true;
            canvas = document.createElement('canvas');
            canvasCtx = canvas.getContext('2d');
            els.interactiveViewport.innerHTML = '';
            els.interactiveViewport.appendChild(video);
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
                stream = s; video.srcObject = stream;
                video.onloadedmetadata = () => { video.play(); scanLoop(); };
            }).catch(err => {
                console.error(err); stopScanner();
                window.showErrorModal("Error al acceder a la cámara.");
                window.resetApp();
            });
        }
        function scanLoop() {
            if (!scannerRunning || !video || video.readyState !== video.HAVE_ENOUGH_DATA) { animationFrameId = requestAnimationFrame(scanLoop); return; }
            if (canvas.width !== video.videoWidth) { canvas.width = video.videoWidth; canvas.height = video.videoHeight; }
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) { stopScanner(); handleQRRead(code.data); } else { animationFrameId = requestAnimationFrame(scanLoop); }
        }
        function stopScanner() {
            scannerRunning = false;
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (stream) stream.getTracks().forEach(t => t.stop());
            video = null;
        }
        function capturePhoto() {
            if (!video || video.readyState !== video.HAVE_ENOUGH_DATA) return;
            canvasCtx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvasCtx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) { stopScanner(); handleQRRead(code.data); } 
            else { window.showErrorModal("No se detectó ningún QR."); }
        }
        function setupPasteCatcher() {
            document.addEventListener('paste', (e) => {
                if (document.getElementById('qr-options-modal').classList.contains('hidden') || !document.getElementById('paste-catcher').matches(':focus')) return;
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const blob = items[i].getAsFile();
                        if (blob) {
                            document.getElementById('qr-options-modal').classList.add('hidden');
                            e.preventDefault();
                            processImageForQR(blob);
                            break;
                        }
                    }
                }
            });
            document.getElementById('modal-paste-image-btn').addEventListener('click', () => {
                document.getElementById('paste-catcher').focus();
                window.showMessageModal("Presione CTRL+V para pegar la imagen.");
                setTimeout(window.hideErrorModal, 3000); 
            });
        }
        function processImageForQR(file) {
            els.loadingStatus.textContent = "Procesando imagen...";
            els.loadingStatus.classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    let { width, height } = img;
                    // Resize for performance
                    const max_dim = 1500;
                    if (width > max_dim || height > max_dim) {
                        const ratio = Math.min(max_dim / width, max_dim / height);
                        width *= ratio; height *= ratio;
                    }
                    tempCanvas.width = width; tempCanvas.height = height;
                    tempCtx.drawImage(img, 0, 0, width, height);
                    try {
                        const imageData = tempCtx.getImageData(0, 0, width, height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        els.loadingStatus.classList.add('hidden');
                        if (code) handleQRRead(code.data);
                        else window.showErrorModal("No se encontró QR en la imagen.");
                    } catch (error) {
                        console.error(error); els.loadingStatus.classList.add('hidden');
                        window.showErrorModal("Error procesando la imagen.");
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- FUNCIÓN DE INICIALIZACIÓN (HACER GLOBAL) ---
        function initApp() {
            // 1. Intentar cargar la última versión de Google Sheets
            fetchTariffsFromSheet();

            // 2. Listeners
            els.startScanBtn.addEventListener('click', startScanner);
            els.stopScanBtn.addEventListener('click', stopScanner);
            els.capturePhotoBtn.addEventListener('click', capturePhoto);
            
            // Listener para mostrar el modal de COPIA
            els.sendOfferBtn.addEventListener('click', () => {
                if (lastComparisonResult) {
                    els.sendOfferModal.classList.remove('hidden');
                } else {
                    window.showErrorModal("Por favor, analice una factura primero para generar una oferta.");
                }
            });
            // Listener para ejecutar la COPIA
            els.executeSendOfferBtn.addEventListener('click', handleCopyOffer);

            // Listeners para el menú de opciones QR manual
            els.uploadMenuBtn.addEventListener('click', () => els.qrOptionsModal.classList.remove('hidden'));
            document.getElementById('modal-upload-file-btn').addEventListener('click', () => document.getElementById('image-file-input').click()); 
            document.getElementById('image-file-input').addEventListener('change', (e) => {
                document.getElementById('qr-options-modal').classList.add('hidden');
                if (e.target.files[0]) processImageForQR(e.target.files[0]);
            });
            
            // Configurar el "pegado" de imagen
            setupPasteCatcher();
            
            console.log("App iniciada. Cargando tarifas automáticamente...");
        }

        // Listeners (Fuera de la función Init para evitar errores de referencia)
        els.startScanBtn.addEventListener('click', startScanner);
        els.stopScanBtn.addEventListener('click', stopScanner);
        els.capturePhotoBtn.addEventListener('click', capturePhoto);
        els.sendOfferBtn.addEventListener('click', () => {
            if (lastComparisonResult) els.sendOfferModal.classList.remove('hidden');
            else window.showErrorModal("Realice un análisis primero.");
        });
        els.executeSendOfferBtn.addEventListener('click', handleCopyOffer);
        els.uploadMenuBtn.addEventListener('click', () => els.qrOptionsModal.classList.remove('hidden'));
        document.getElementById('modal-upload-file-btn').addEventListener('click', () => document.getElementById('image-file-input').click()); 
        document.getElementById('image-file-input').addEventListener('change', (e) => {
            document.getElementById('qr-options-modal').classList.add('hidden');
            if (e.target.files[0]) processImageForQR(e.target.files[0]);
        });


        window.onload = initApp;

    </script>
</body>
</html>
